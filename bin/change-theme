#!/bin/bash

cfg=~/.config/.terminal-theme
specified_theme=$1

get_cur_theme() {
  if [ ! -f "$cfg" ]; then
    echo 'dark' > $cfg
  fi
  echo `cat $cfg`
}

get_next_theme() {
  if [ ! "$specified_theme" ]; then
    if [ "$1" == 'dark' ]; then
      echo 'light'
    else
      echo 'dark'
    fi
  else
    echo $specified_theme
  fi
}
 
_sed() {
  sed_cmd1=$1
  sed_cmd2=$2
  os=`uname -s`
  if [ "$os" == 'Darwin' ]; then
    sed -i '' $sed_cmd1 $3
    sed -i '' $sed_cmd2 $3
  else
    sed -i $sed_cmd1 $3
    sed -i $sed_cmd2 $3
  fi
}

change_alacritty () {
  alacritty_cfg=~/.config/alacritty/alacritty.yml
  if test -f "$alacritty_cfg"; then
    cur=$1
    next=$2
    cur_in_cfg=`cat $alacritty_cfg | grep "^colors-.*:$" | awk '{print(index($1,"dark")>0?"light":"dark")}'`
    if [ "$next" != "$cur_in_cfg" ]; then
      sed_cmd1='s/^colors:/colors-'$cur':/g'
      sed_cmd2='s/^colors-'$next':/colors:/g'
      _sed $sed_cmd1 $sed_cmd2 $alacritty_cfg
    fi
  fi
}

change_kitty () {
  kitty_cfg_dir=~/.config/kitty
  theme_dir="$kitty_cfg_dir/themes"

  dark_theme="$theme_dir/Gruvbox Material Dark Medium.conf"
  light_theme="$theme_dir/Base16 Google Light.conf"
  current_theme="$theme_dir/current-theme.conf"

  if [[ -f $dark_theme && -f $light_theme ]]; then
    next=$2
    if [ $next == "dark" ]; then
      rm $current_theme
      ln -s "$dark_theme" $current_theme
    else
      rm $current_theme
      ln -s "$light_theme" $current_theme
    fi
    ls /tmp/kitty.socket-* | xargs -I{} \
      /Applications/kitty.app/Contents/MacOS/kitty \
      @ --to unix:{} \
      set-colors --all --configured $current_theme  2>/dev/null
  fi
}

change_nvim () {
  next=$2
  # light / dark -> :Light<CR> / :Dark<CR>
  nvim_cmd=":$(tr '[:lower:]' '[:upper:]' <<< ${next:0:1})${next:1}<CR>"
  # https://neovim.io/doc/user/builtin.html#serverlist()
  ls ${XDG_RUNTIME_DIR:-${TMPDIR}nvim.${USER}}/*/nvim.*.0 | xargs -I{} echo {} \
    | xargs -I{} nvim --server {} --remote-send $nvim_cmd >/dev/null 2>&1
} 

change () {
  cur=`get_cur_theme`
  next=`get_next_theme $cur`

  change_alacritty $cur $next
  change_kitty $cur $next
  change_nvim $cur $next

  echo $next > $cfg
}

change
